server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  
  ssl_protocols         TLSv1.2 TLSv1.3;
  ssl_verify_client on;

	client_max_body_size 100M;

  server_name          ${WEB_DOMAINS};

  location /${V2FLY_GRPC_SERVICE_NAME} { # This michi shall in consistent with the grpc serviceName in v2ray config.json
  
    if ($request_method != "POST") { # if the request method is not POST for this location, return 404
        return 404;
    }

    grpc_socket_keepalive on;
    grpc_intercept_errors on;
    grpc_pass grpc://127.0.0.1:${V2FLY_GRPC_PORT}; # presume v2ray is listening on port 12345 
    grpc_set_header Upgrade $http_upgrade;
    grpc_set_header Connection "upgrade";
    grpc_set_header Host $host;
    # Show real IP in v2ray access.log
    grpc_set_header X-Real-IP $remote_addr;
    grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /${V2FLY_WEBSOCKET_PATH} {

	    if ($http_upgrade != "websocket") { # Return 404 error when WebSocket upgrading negotiate failed
          return 404;
      }

      proxy_redirect off;
      proxy_pass http://127.0.0.1:${V2FLY_WEBSOCKET_PORT}; # Assume WebSocket is listening at localhost on port of 10000
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      # Show real IP in v2ray access.log
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /tor-${V2FLY_WEBSOCKET_PATH} {

	    if ($http_upgrade != "websocket") { # Return 404 error when WebSocket upgrading negotiate failed
          return 404;
      }

      proxy_redirect off;
      proxy_pass http://127.0.0.1:${V2FLY_WEBSOCKET_PORT}; # Assume WebSocket is listening at localhost on port of 10000
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      # Show real IP in v2ray access.log
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /vpn-${V2FLY_WEBSOCKET_PATH} {

	    if ($http_upgrade != "websocket") { # Return 404 error when WebSocket upgrading negotiate failed
          return 404;
      }

      proxy_redirect off;
      proxy_pass http://127.0.0.1:${V2FLY_WEBSOCKET_PORT}; # Assume WebSocket is listening at localhost on port of 10000
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      # Show real IP in v2ray access.log
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
